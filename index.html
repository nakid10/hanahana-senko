<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ドラゴンハナハナ閃光｜設定判別（個人用）</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2e;
      --text:#e8eefc;
      --muted:#aab6d6;
      --line:#24324f;

      --btn:#1e2b47;
      --btn2:#243553;
      --accent:#7aa2ff;
      --danger:#fb7185;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;

      --controlH:48px;
      --labelH:18px;
      --gap:12px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 20% -10%, #1b2b5a, transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, #17385a, transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:16px 12px 28px;
    }
    .container{ max-width: 1100px; margin:0 auto; }
    header{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; margin: 8px 0 14px; }
    h1{ font-size:18px; margin:0; letter-spacing:.02em; }
    .sub{ color:var(--muted); font-size:12px; line-height:1.6; margin-top:6px; max-width: 780px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(122,162,255,.12);
      border:1px solid rgba(122,162,255,.25);
      color:var(--text); font-size:12px; white-space:nowrap;
    }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 14px; }
    .tabbtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      height: var(--controlH);
      padding:0 14px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
      transition:.12s;
      user-select:none;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .tabbtn:hover{ background: rgba(255,255,255,.10); }
    .tabbtn.active{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.35);
    }

    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:var(--gap); }
    @media (max-width: 920px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 12px; font-size:14px; letter-spacing:.02em; }

    .formGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
      align-items:end;
    }
    .col-12{ grid-column: span 12; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }
    @media (max-width: 720px){
      .col-6,.col-4,.col-3{ grid-column: span 12; }
    }

    .field label{
      display:block;
      height: var(--labelH);
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    input, select, textarea{
      width:100%;
      height: var(--controlH);
      padding: 0 12px;
      background: rgba(10,16,28,.6);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: var(--radius2);
      outline:none;
      font-size: 14px;
    }

    .hint{ color:var(--muted); font-size:12px; line-height:1.5; margin-top:6px; }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin: 14px 0; }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: var(--btn);
      color: var(--text);
      height: var(--controlH);
      padding:0 14px;
      border-radius: var(--radius2);
      cursor:pointer;
      font-size: 13px;
      transition:.12s;
      user-select:none;
      display:inline-flex; align-items:center; justify-content:center;
      white-space:nowrap;
    }
    .btn:hover{ background: var(--btn2); }
    .btn.primary{
      background: rgba(122,162,255,.22);
      border-color: rgba(122,162,255,.38);
    }
    .btn.danger{
      background: rgba(251,113,133,.16);
      border-color: rgba(251,113,133,.35);
    }
    .btn.ghost{ background: transparent; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    @media (max-width: 720px){
      .btnRow .btn{ flex: 1 1 180px; }
    }

    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      height: var(--controlH);
      padding: 0 12px;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 14px;
      font-weight: 800;
      min-width: 92px;
    }
    .stepRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:10px;
      align-items:center;
    }
    .stepRow .btn{ width:100%; }
    .stepRow .chip{ width:100%; }
    @media (max-width: 720px){
      .stepRow{ grid-template-columns: 1fr 1fr; }
    }

    .result{
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius2);
      background: rgba(15,24,42,.65);
      border:1px solid rgba(255,255,255,.10);
    }
    .badges{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 10px; }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      height: 34px;
      padding: 0 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 920px){ .kpi{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px){ .kpi{ grid-template-columns: 1fr; } }
    .k{
      padding: 10px 12px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
    }
    .k .t{ font-size:12px; color:var(--muted); }
    .k .v{ font-size:16px; margin-top:6px; font-weight: 900; letter-spacing:.02em; }

    /* 今日の履歴（右カードの小一覧） */
    .todayWrap{ display:flex; flex-direction:column; gap:10px; }
    .todayTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .todayList{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height: 520px;
      overflow:auto;
      padding-right: 2px;
    }
    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }
    .miniMain{
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .01em;
      min-width: 88px;
    }
    .miniSub{
      color: var(--muted);
      font-size: 12px;
      flex: 1 1 auto;
      min-width: 160px;
    }
    .miniDel{
      height: 34px;
      padding: 0 10px;
      border-radius: 999px;
      border:1px solid rgba(251,113,133,.35);
      background: rgba(251,113,133,.16);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
      font-weight: 900;
      user-select:none;
    }

    table{ width:100%; border-collapse: collapse; margin-top:10px; }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      text-align:left;
      vertical-align: top;
    }
    th{ color: var(--muted); font-weight: 900; }
    .right{ text-align:right; }
    .hidden{ display:none !important; }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 12px;
      z-index: 9999;
    }
    .modal{
      width: min(820px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modal h3{ margin: 0 0 12px; font-size: 14px; }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      height: var(--controlH);
      padding: 0 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-size: 13px;
      user-select:none;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .seg button.active{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.35);
    }
    .small{ font-size:12px; color:var(--muted); line-height:1.6; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>ドラゴンハナハナ～閃光～｜設定判別（個人用）</h1>
        <div class="sub">
          ・ドラハナは<strong>BIG偏向型</strong>（REGが弱い＝即NGはしません）<br>
          ・<strong>REG後フェザー＝設定確定（最優先）</strong>／BIG後フェザー＝示唆のみ<br>
          ・当選G数は「合算の補助」＋「今日の履歴」＋「過去分布（アーカイブ）」に使うよ
        </div>
      </div>
      <div class="pill"><strong>今日の履歴</strong><span style="color:var(--muted)">は判定に表示</span></div>
    </header>

    <div class="tabs">
      <button class="tabbtn active" data-tab="judge">判定</button>
      <button class="tabbtn" data-tab="dist">分布（過去）</button>
      <button class="tabbtn" data-tab="io">引き継ぎ</button>
    </div>

    <!-- 判定 -->
    <section id="tab-judge" class="tab">
      <div class="grid">
        <!-- 左：入力＋判定 -->
        <div class="card">
          <h2>入力</h2>

          <div class="formGrid">
            <div class="field col-6">
              <label>総回転数（通常G）</label>
              <input id="totalG" inputmode="numeric" placeholder="例：3200" />
              <div class="hint">序盤/中盤/終盤の重み付けに使うよ。</div>
            </div>

            <div class="field col-3">
              <label>BIG回数</label>
              <input id="bigCnt" inputmode="numeric" placeholder="例：12" />
            </div>

            <div class="field col-3">
              <label>REG回数</label>
              <input id="regCnt" inputmode="numeric" placeholder="例：6" />
            </div>

            <div class="field col-6">
              <label>ベル回数（任意・手入力）</label>
              <input id="bellCnt" inputmode="numeric" placeholder="例：420" />
              <div class="hint">※ベルは逆算値しか無いので「参考」扱い。</div>
            </div>

            <div class="field col-6">
              <label>BIG中スイカ（合計：ワンタップ）</label>
              <div class="stepRow">
                <button class="btn" id="suiMinus" type="button">-1</button>
                <div class="chip"><span id="suiVal">0</span>&nbsp;回</div>
                <button class="btn" id="suiPlus" type="button">+1</button>
                <button class="btn ghost" id="suiReset" type="button">リセット</button>
              </div>
              <div class="hint">※序盤はブレやすいので評価は控えめ。</div>
            </div>

            <div class="col-12">
              <div class="btnRow">
                <button class="btn primary" id="btnJudge" type="button">判定する</button>
                <button class="btn" id="btnAddBonus" type="button">ボーナス追加（当選G/色）</button>
                <button class="btn ghost" id="btnResetAll" type="button">入力リセット</button>
              </div>
            </div>
          </div>

          <div id="judgeResult" class="result hidden">
            <div class="badges">
              <div class="badge" id="rankText">-</div>
              <div class="badge" id="phaseText">-</div>
              <div class="badge" id="guaranteeText">-</div>
            </div>

            <div class="kpi">
              <div class="k"><div class="t">合算</div><div class="v" id="bonusRate">-</div></div>
              <div class="k"><div class="t">REG</div><div class="v" id="regRate">-</div></div>
              <div class="k"><div class="t">BIG</div><div class="v" id="bigRate">-</div></div>
              <div class="k"><div class="t">当選Gの傾向（補助）</div><div class="v" id="distHint">-</div></div>
            </div>

            <div class="sep"></div>
            <div class="small">
              <div><strong>根拠</strong>：<span id="reasonText">-</span></div>
              <div style="margin-top:6px;"><strong>コメント</strong>：<span id="commentText">-</span></div>
              <div style="margin-top:6px;">※ドラハナはBIG偏向型。REGが弱い＝即否定にはしないよ（REGが良い時だけ加点）。</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="small">
            <div style="font-weight:900; color:var(--muted);">固定メモ</div>
            <div style="margin-top:6px;">
              ・REG後フェザー：青(2+) / 黄(3+) / 緑(4+) / 赤(5+) / 虹(6)<br>
              ・BIG後フェザー：示唆のみ（青LOW〜赤やや高設定寄り）<br>
              ・設定別 合算：設1 1/183 → 設6 1/133
            </div>
          </div>
        </div>

        <!-- 右：今日の履歴（小一覧） -->
        <div class="card">
          <h2>今日のボーナス履歴（一覧・小さめ）</h2>
          <div class="todayWrap">
            <div class="todayTop">
              <div class="small">
                <div><strong id="todayKeyText">-</strong></div>
                <div>※今日の分だけここに全部出るよ。過去分は自動で「分布（過去）」へ移動。</div>
              </div>
              <div class="btnRow" style="margin:0;">
                <button class="btn danger" id="btnClearToday" type="button">今日を全削除</button>
              </div>
            </div>

            <div id="todayEmpty" class="small">まだ今日の履歴がありません。</div>
            <div id="todayList" class="todayList"></div>

            <div class="sep"></div>
            <div class="small">
              例）<strong>125G BIG</strong>（スイカ+1 / フェザー青）<br>
              例）<strong>80G REG</strong>（サイド緑 / REG後フェザー黄(3+)）
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 分布（過去） -->
    <section id="tab-dist" class="tab hidden">
      <div class="grid">
        <div class="card">
          <h2>当選分布（100G刻み・過去アーカイブ）</h2>
          <div class="small">
            ※ここは「過去分のみ」。今日の履歴は判定タブに置いて、終わったら自然にアーカイブされるよ。
          </div>

          <div class="formGrid" style="margin-top:12px;">
            <div class="field col-8">
              <label>表示上限（G）</label>
              <input id="histMaxG" inputmode="numeric" placeholder="空欄なら自動（最大当選Gに合わせる）" />
            </div>
            <div class="col-4">
              <label>&nbsp;</label>
              <button class="btn" id="btnRefreshHist" type="button">分布を更新</button>
            </div>
          </div>

          <div id="histWrap"></div>
        </div>

        <div class="card">
          <h2>アーカイブ状況</h2>
          <div class="small" id="archiveStats">-</div>
          <div class="sep"></div>
          <div class="btnRow">
            <button class="btn" id="btnForceArchive" type="button">過去分をアーカイブに移す（手動）</button>
          </div>
          <div class="small" style="margin-top:10px;">
            ※通常はページを開いたタイミングで自動で仕分けされるよ。
          </div>
        </div>
      </div>
    </section>

    <!-- 引き継ぎ -->
    <section id="tab-io" class="tab hidden">
      <div class="card">
        <h2>引き継ぎ（書き出し / 読み込み）</h2>
        <div class="small">
          端末変更やSafariのデータ消去に備えて、定期的にJSONを書き出してね。<br>
          ※更新しても履歴が消えないよう、保存キーと構造は固定してあるよ。
        </div>

        <div class="btnRow" style="margin-top:12px;">
          <button class="btn primary" id="exportBtn" type="button">JSONを書き出す</button>
          <button class="btn" id="importBtn" type="button">JSONを読み込む</button>
          <button class="btn danger" id="btnWipeAll" type="button">全データ削除</button>
          <input id="importFile" type="file" accept="application/json" class="hidden">
        </div>
      </div>
    </section>
  </div>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <h3>ボーナス追加（当選G / 色）</h3>

      <div class="formGrid">
        <div class="field col-6">
          <label>当選G数</label>
          <input id="mHitG" inputmode="numeric" placeholder="例：380" />
          <div class="hint">今日の履歴に追加されるよ（過去分は後で自動アーカイブ）。</div>
        </div>

        <div class="field col-6">
          <label>種別</label>
          <div class="seg" id="mTypeSeg">
            <button type="button" data-type="BIG" class="active">BIG</button>
            <button type="button" data-type="REG">REG</button>
          </div>
        </div>

        <div class="col-12"><div class="sep"></div></div>

        <div class="field col-6">
          <label>BIG後フェザー（示唆のみ）</label>
          <select id="mFeatherBig">
            <option value="none">未入力</option>
            <option value="white">白（LOW）</option>
            <option value="blue">青（LOW）</option>
            <option value="yellow">黄（LOW〜MID）</option>
            <option value="green">緑（MID）</option>
            <option value="red">赤（やや高設定寄り）</option>
          </select>
        </div>

        <div class="field col-6">
          <label>REG後フェザー（設定確定）</label>
          <select id="mFeatherReg">
            <option value="none">未入力</option>
            <option value="blue">青（設定2以上確定）</option>
            <option value="yellow">黄（設定3以上確定）</option>
            <option value="green">緑（設定4以上確定）</option>
            <option value="red">赤（設定5以上確定）</option>
            <option value="rainbow">虹（設定6確定）</option>
          </select>
          <div class="hint">※REG選択時のみ有効。</div>
        </div>

        <div class="field col-6">
          <label>サイドランプ（任意）</label>
          <select id="mSideLamp">
            <option value="none">未入力</option>
            <option value="blue">青（奇数示唆）</option>
            <option value="green">緑（奇数＋高設定寄り）</option>
            <option value="yellow">黄（偶数示唆）</option>
            <option value="red">赤（偶数＋高設定寄り）</option>
            <option value="rainbow">虹（高設定期待度UP）</option>
          </select>
          <div class="hint">※REG選択時のみ有効。</div>
        </div>

        <div class="field col-6">
          <label>このBIGでスイカを足す（任意）</label>
          <div class="stepRow">
            <button class="btn" id="mSuiMinus" type="button">-1</button>
            <div class="chip"><span id="mSuiAdd">0</span>&nbsp;回</div>
            <button class="btn" id="mSuiPlus" type="button">+1</button>
            <button class="btn ghost" id="mSuiZero" type="button">0に戻す</button>
          </div>
          <div class="hint">※BIG選択時のみ加算。</div>
        </div>

        <div class="col-12">
          <div class="btnRow" style="justify-content:space-between;">
            <button class="btn ghost" id="mCancel" type="button">キャンセル</button>
            <div class="btnRow" style="flex:0 0 auto;">
              <button class="btn" id="mSaveOnly" type="button">保存（履歴だけ）</button>
              <button class="btn primary" id="mSaveAndApply" type="button">保存して回数にも反映</button>
            </div>
          </div>
          <div class="small" style="margin-top:8px;">
            「回数にも反映」＝BIG/REG回数＋スイカ合計も自動で増える（二度手間防止）。
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 保存形式（固定）
     ***********************/
    const STORAGE_KEY = "dragon_hana_senka_v2";
    const STORAGE_VERSION = 2;

    function newStore(){
      return {
        version: STORAGE_VERSION,
        inputs: { totalG:"", big:"", reg:"", bell:"", sui:0 },
        // 今日の履歴（todayKey一致のもの）
        todayKey: getTodayKey(),
        hitsToday: [],
        // 過去アーカイブ（分布用）
        hitsArchive: []
      };
    }

    function loadStore(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){
        const init = newStore();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
        return init;
      }
      try{
        const data = JSON.parse(raw);
        if(data && data.version === STORAGE_VERSION){
          // 欠損補修
          if(!data.inputs) data.inputs = { totalG:"", big:"", reg:"", bell:"", sui:0 };
          if(typeof data.inputs.sui !== "number") data.inputs.sui = 0;
          if(!Array.isArray(data.hitsToday)) data.hitsToday = [];
          if(!Array.isArray(data.hitsArchive)) data.hitsArchive = [];
          if(!data.todayKey) data.todayKey = getTodayKey();
          return data;
        }
      }catch(e){}
      const fallback = newStore();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fallback));
      return fallback;
    }

    function saveStore(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }

    function parseIntSafe(v){
      const n = parseInt(String(v ?? "").replace(/[^\d]/g,""), 10);
      return Number.isFinite(n) ? n : null;
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function getTodayKey(){
      // ローカル日付で YYYY-MM-DD
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function nowISO(){ return new Date().toISOString(); }

    function jpTime(iso){
      try{
        const d = new Date(iso);
        const y=d.getFullYear();
        const m=String(d.getMonth()+1).padStart(2,"0");
        const da=String(d.getDate()).padStart(2,"0");
        const hh=String(d.getHours()).padStart(2,"0");
        const mm=String(d.getMinutes()).padStart(2,"0");
        return `${y}/${m}/${da} ${hh}:${mm}`;
      }catch{ return iso; }
    }

    function fmtRate(g, cnt){
      if(!g || !cnt) return "-";
      const r = g / cnt;
      return `1/${r.toFixed(2)}`;
    }

    function minSettingFromRegFeather(val){
      if(val === "blue") return 2;
      if(val === "yellow") return 3;
      if(val === "green") return 4;
      if(val === "red") return 5;
      if(val === "rainbow") return 6;
      return null;
    }
    function bigFeatherScore(val){
      if(val === "blue") return 0.3;
      if(val === "yellow") return 0.5;
      if(val === "green") return 0.8;
      if(val === "red") return 1.0;
      if(val === "white") return 0.0;
      return 0.0;
    }
    function sideLampHint(val){
      if(val === "blue") return { odd:1, even:0 };
      if(val === "green") return { odd:1, even:0 };
      if(val === "yellow") return { odd:0, even:1 };
      if(val === "red") return { odd:0, even:1 };
      return { odd:0, even:0 };
    }

    /***********************
     * 自動アーカイブ
     * - ページを開いた時点で
     *   store.todayKey が今日と違えば
     *   hitsToday を hitsArchive に移す
     ***********************/
    function autoArchiveIfNeeded(){
      const today = getTodayKey();
      if(store.todayKey !== today){
        // 旧hitsTodayをアーカイブへ
        if(store.hitsToday.length){
          store.hitsArchive.push(...store.hitsToday);
        }
        store.hitsToday = [];
        store.todayKey = today;
        saveStore();
      }
    }

    /***********************
     * tabs
     ***********************/
    const tabBtns = Array.from(document.querySelectorAll(".tabbtn"));
    const tabs = {
      judge: document.getElementById("tab-judge"),
      dist: document.getElementById("tab-dist"),
      io: document.getElementById("tab-io"),
    };
    function openTab(name){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === name));
      Object.entries(tabs).forEach(([k,el]) => el.classList.toggle("hidden", k !== name));
      if(name === "dist"){ renderHist(); renderArchiveStats(); }
      if(name === "judge"){ renderTodayList(); }
    }
    tabBtns.forEach(b => b.addEventListener("click", () => openTab(b.dataset.tab)));

    /***********************
     * store init
     ***********************/
    let store = loadStore();
    autoArchiveIfNeeded(); // 起動時に仕分け
    document.getElementById("todayKeyText").textContent = store.todayKey;

    /***********************
     * inputs bind
     ***********************/
    const elTotalG = document.getElementById("totalG");
    const elBigCnt = document.getElementById("bigCnt");
    const elRegCnt = document.getElementById("regCnt");
    const elBellCnt = document.getElementById("bellCnt");
    const elSuiVal = document.getElementById("suiVal");

    function loadInputsToUI(){
      elTotalG.value = store.inputs.totalG ?? "";
      elBigCnt.value = store.inputs.big ?? "";
      elRegCnt.value = store.inputs.reg ?? "";
      elBellCnt.value = store.inputs.bell ?? "";
      elSuiVal.textContent = String(store.inputs.sui ?? 0);
    }
    function saveInputsFromUI(){
      store.inputs.totalG = elTotalG.value;
      store.inputs.big = elBigCnt.value;
      store.inputs.reg = elRegCnt.value;
      store.inputs.bell = elBellCnt.value;
      saveStore();
    }

    ["input","change"].forEach(evt => {
      elTotalG.addEventListener(evt, saveInputsFromUI);
      elBigCnt.addEventListener(evt, saveInputsFromUI);
      elRegCnt.addEventListener(evt, saveInputsFromUI);
      elBellCnt.addEventListener(evt, saveInputsFromUI);
    });

    document.getElementById("suiPlus").addEventListener("click", () => {
      store.inputs.sui = (store.inputs.sui ?? 0) + 1;
      elSuiVal.textContent = String(store.inputs.sui);
      saveStore();
    });
    document.getElementById("suiMinus").addEventListener("click", () => {
      store.inputs.sui = Math.max(0, (store.inputs.sui ?? 0) - 1);
      elSuiVal.textContent = String(store.inputs.sui);
      saveStore();
    });
    document.getElementById("suiReset").addEventListener("click", () => {
      store.inputs.sui = 0;
      elSuiVal.textContent = "0";
      saveStore();
    });

    /***********************
     * 判定ロジック
     ***********************/
    function phaseFromG(g){
      if(g >= 4000) return {key:"late", label:"終盤（4000G〜）"};
      if(g >= 2500) return {key:"mid",  label:"中盤（2500〜4000G）"};
      if(g >= 1000) return {key:"early",label:"序盤（1000〜2500G）"};
      return {key:"pre", label:"準備（〜1000G）"};
    }

    function distScoreHintFromToday(){
      const hits = store.hitsToday || [];
      if(hits.length < 8) return { text:"データ少（補助弱め）", score: 0 };

      const recent = hits.slice(-20);
      let shallow = 0; // 0-200
      let deep = 0;    // 600+
      for(const h of recent){
        if((h.g ?? 0) < 200) shallow++;
        if((h.g ?? 0) >= 600) deep++;
      }
      let score = 0;
      if(shallow >= 8) score += 2;
      else if(shallow >= 6) score += 1;

      if(deep >= 6) score -= 2;
      else if(deep >= 4) score -= 1;

      let text = "中立";
      if(score >= 2) text = "浅い当選が多め（合算が少し良化しやすい）";
      else if(score === 1) text = "浅い当選がやや多め（少し良化）";
      else if(score === -1) text = "深めがやや目立つ（少し注意）";
      else if(score <= -2) text = "深いハマりが目立つ（合算に注意）";
      return { text, score };
    }

    function aggregateHintsFromToday(){
      const hits = store.hitsToday || [];
      let minSet = 0;
      let bigFeather = 0;
      let odd = 0, even = 0;

      for(const h of hits){
        if(h.type === "REG"){
          const ms = minSettingFromRegFeather(h.featherReg);
          if(ms) minSet = Math.max(minSet, ms);
          const sh = sideLampHint(h.sideLamp);
          odd += sh.odd; even += sh.even;
        }
        if(h.type === "BIG"){
          bigFeather += bigFeatherScore(h.featherBig);
        }
      }

      let parity = "不明";
      if(odd + even >= 6){
        if(odd > even + 1) parity = "奇数寄り";
        else if(even > odd + 1) parity = "偶数寄り";
        else parity = "拮抗";
      }

      return { minSet, bigFeather, parity };
    }

    function judge(){
      const g = parseIntSafe(elTotalG.value) ?? 0;
      const big = parseIntSafe(elBigCnt.value) ?? 0;
      const reg = parseIntSafe(elRegCnt.value) ?? 0;
      const bell = parseIntSafe(elBellCnt.value);
      const sui = store.inputs.sui ?? 0;

      const phase = phaseFromG(g);
      const totalBonus = big + reg;

      const dist = distScoreHintFromToday();
      const hints = aggregateHintsFromToday();

      let guarantee = null;
      if(hints.minSet >= 6) guarantee = "設定6濃厚（REG後フェザー虹）";
      else if(hints.minSet >= 5) guarantee = "設定5以上濃厚（REG後フェザー赤）";
      else if(hints.minSet >= 4) guarantee = "設定4以上濃厚（REG後フェザー緑）";
      else if(hints.minSet >= 3) guarantee = "設定3以上濃厚（REG後フェザー黄）";
      else if(hints.minSet >= 2) guarantee = "設定2以上濃厚（REG後フェザー青）";

      let score = 0;
      let reasons = [];

      // BIG後フェザー（示唆）
      if(hints.bigFeather > 0){
        const add = clamp(hints.bigFeather, 0, 3);
        score += add;
        reasons.push(`BIG後フェザー示唆 +${add.toFixed(1)}`);
      }

      // 合算（控えめ）
      if(g >= 500 && totalBonus >= 3){
        const obsAll = g / Math.max(1, totalBonus);
        const good = obsAll <= 163;
        const veryGood = obsAll <= 153;
        const excellent = obsAll <= 143;

        let w = 1.0;
        if(phase.key === "early") w = 1.0;
        if(phase.key === "mid") w = 1.4;
        if(phase.key === "late") w = 1.7;

        const distAdj = dist.score * 0.3;

        if(excellent) { score += 3.0*w + distAdj; reasons.push(`合算かなり良い（〜設5-6帯）`); }
        else if(veryGood) { score += 2.2*w + distAdj; reasons.push(`合算良い（〜設4-5帯）`); }
        else if(good) { score += 1.2*w + distAdj; reasons.push(`合算まずまず（〜設3帯）`); }
        else { score += 0.2*w + distAdj; reasons.push(`合算は平均付近（ブレも含む）`); }
      } else {
        reasons.push("合算：サンプル少（参考）");
      }

      // REG（加点のみ）
      if(g >= 800 && reg >= 2){
        const obsReg = g / Math.max(1, reg);
        let w = 1.0;
        if(phase.key === "early") w = 0.8;
        if(phase.key === "mid") w = 1.3;
        if(phase.key === "late") w = 1.7;

        if(obsReg <= 399) { score += 3.2*w; reasons.push("REGが強い（設6帯）"); }
        else if(obsReg <= 442) { score += 2.6*w; reasons.push("REGが良い（設5帯）"); }
        else if(obsReg <= 489) { score += 2.1*w; reasons.push("REGが良い（設4帯）"); }
        else if(obsReg <= 537) { score += 1.5*w; reasons.push("REGがやや良い（設3帯）"); }
        else if(obsReg <= 585) { score += 0.9*w; reasons.push("REGは悪くない（設2帯）"); }
        else if(obsReg <= 642) { score += 0.4*w; reasons.push("REGは標準域（設1帯）"); }
        else { reasons.push("REGは荒れやすい（否定材料にしない）"); }
      } else {
        reasons.push("REG：少ない場合は加点しづらい（否定はしない）");
      }

      // BIG（軽い加点）
      if(g >= 800 && big >= 2){
        const obsBig = g / Math.max(1, big);
        let w = 1.0;
        if(phase.key === "early") w = 0.6;
        if(phase.key === "mid") w = 0.8;
        if(phase.key === "late") w = 1.0;

        if(obsBig <= 199) { score += 1.2*w; reasons.push("BIGが軽め（設6帯）"); }
        else if(obsBig <= 212) { score += 1.0*w; reasons.push("BIGが軽め（設5帯）"); }
        else if(obsBig <= 224) { score += 0.8*w; reasons.push("BIGがやや軽い（設4帯）"); }
        else if(obsBig <= 235) { score += 0.6*w; reasons.push("BIGがやや軽い（設3帯）"); }
        else { score += 0.2*w; reasons.push("BIGは標準（偏りは想定内）"); }
      } else {
        reasons.push("BIG：サンプル少（参考）");
      }

      // スイカ（補助）
      if(big >= 10 && sui > 0){
        const perBig = sui / big;
        let w = 1.0;
        if(phase.key === "early") w = 0.5;
        if(phase.key === "mid") w = 0.9;
        if(phase.key === "late") w = 1.2;

        if(perBig >= 1.0) { score += 1.0*w; reasons.push("BIG中スイカが良い（補助）"); }
        else if(perBig >= 0.8) { score += 0.7*w; reasons.push("BIG中スイカがやや良い（補助）"); }
        else if(perBig >= 0.6) { score += 0.3*w; reasons.push("BIG中スイカは標準（補助）"); }
        else { reasons.push("BIG中スイカは参考（ブレ）"); }
      } else {
        reasons.push("BIG中スイカ：サンプル少（参考）");
      }

      // ベル参考
      let bellMsg = "ベル：未入力";
      if(bell !== null && g > 0){
        const rate = g / Math.max(1, bell);
        if(rate < 7.0) bellMsg = `ベル参考：1/${rate.toFixed(2)}（7を切っていて好感触かも）`;
        else bellMsg = `ベル参考：1/${rate.toFixed(2)}（目安域）`;
      }
      reasons.push(bellMsg);

      if(hints.parity !== "不明"){
        reasons.push(`サイドランプ傾向：${hints.parity}（参考）`);
      }

      const bonusRate = (g && totalBonus) ? fmtRate(g, totalBonus) : "-";
      const regRate = (g && reg) ? fmtRate(g, reg) : "-";
      const bigRate = (g && big) ? fmtRate(g, big) : "-";

      let rankText = "NG：慎重（低設定寄りの可能性）";
      if(score >= 11) rankText="S：高設定濃厚（粘る価値大）";
      else if(score >= 8) rankText="A：高設定期待（続行候補）";
      else if(score >= 5) rankText="B：中間の可能性（様子見）";

      // 確定で上書き
      if(hints.minSet >= 6) rankText="S：設定6濃厚（確定）";
      else if(hints.minSet >= 5) rankText="S：設定5以上濃厚（確定）";
      else if(hints.minSet >= 4) rankText="A：設定4以上濃厚（確定）";
      else if(hints.minSet >= 3) rankText="B：設定3以上濃厚（確定）";
      else if(hints.minSet >= 2) rankText="B：設定2以上濃厚（確定）";

      let comment = "";
      if(hints.minSet >= 4){
        comment = "REG後フェザー確定が強いよ。数値が荒れても焦らず、資金管理だけ丁寧にね。";
      } else if(rankText.startsWith("S")){
        comment = "示唆と数値が噛み合ってる。ドラハナの荒れを許容しつつ続行寄りでOK。";
      } else if(rankText.startsWith("A")){
        comment = "期待できる材料が揃ってきたよ。REGが引けてたら特に良い流れ。";
      } else if(rankText.startsWith("B")){
        comment = "中間〜上をまだ否定しない感じ。強示唆待ちつつ様子見が安全かな。";
      } else {
        comment = "今は強い根拠が少なめ。無理せず次の当たりと示唆で再評価しよ。";
      }

      return {
        phaseLabel: phase.label,
        rankText: `${rankText}（スコア ${score.toFixed(2)}）`,
        guaranteeText: guarantee ? guarantee : "確定：なし",
        bonusRate, regRate, bigRate,
        distText: dist.text,
        reasons: reasons.filter(Boolean),
        comment
      };
    }

    /***********************
     * 判定描画
     ***********************/
    const judgeResult = document.getElementById("judgeResult");
    const rankTextEl = document.getElementById("rankText");
    const phaseTextEl = document.getElementById("phaseText");
    const guaranteeTextEl = document.getElementById("guaranteeText");
    const bonusRateEl = document.getElementById("bonusRate");
    const regRateEl = document.getElementById("regRate");
    const bigRateEl = document.getElementById("bigRate");
    const distHintEl = document.getElementById("distHint");
    const reasonTextEl = document.getElementById("reasonText");
    const commentTextEl = document.getElementById("commentText");

    document.getElementById("btnJudge").addEventListener("click", () => {
      saveInputsFromUI();
      const r = judge();
      judgeResult.classList.remove("hidden");
      rankTextEl.textContent = r.rankText;
      phaseTextEl.textContent = r.phaseLabel;
      guaranteeTextEl.textContent = r.guaranteeText;
      bonusRateEl.textContent = r.bonusRate;
      regRateEl.textContent = r.regRate;
      bigRateEl.textContent = r.bigRate;
      distHintEl.textContent = r.distText;
      reasonTextEl.textContent = r.reasons.join("／");
      commentTextEl.textContent = r.comment;
    });

    document.getElementById("btnResetAll").addEventListener("click", () => {
      elTotalG.value = "";
      elBigCnt.value = "";
      elRegCnt.value = "";
      elBellCnt.value = "";
      store.inputs = { totalG:"", big:"", reg:"", bell:"", sui:0 };
      saveStore();
      elSuiVal.textContent = "0";
      judgeResult.classList.add("hidden");
    });

    /***********************
     * 今日の履歴（右カード）
     ***********************/
    const todayEmpty = document.getElementById("todayEmpty");
    const todayList = document.getElementById("todayList");
    function colorJP(v){
      const map = {white:"白", blue:"青", yellow:"黄", green:"緑", red:"赤", rainbow:"虹"};
      return map[v] || v;
    }
    function regFeatherJP(v){
      const map = {blue:"青(2+)", yellow:"黄(3+)", green:"緑(4+)", red:"赤(5+)", rainbow:"虹(6)"};
      return map[v] || v;
    }
    function makeMiniSub(h){
      if(h.type === "BIG"){
        const parts = [];
        if(h.suiAdd && h.suiAdd > 0) parts.push(`スイカ+${h.suiAdd}`);
        if(h.featherBig && h.featherBig !== "none") parts.push(`フェザー${colorJP(h.featherBig)}`);
        return parts.join(" / ") || "（詳細なし）";
      } else {
        const parts = [];
        if(h.sideLamp && h.sideLamp !== "none") parts.push(`サイド${colorJP(h.sideLamp)}`);
        if(h.featherReg && h.featherReg !== "none") parts.push(`REG後フェザー${regFeatherJP(h.featherReg)}`);
        return parts.join(" / ") || "（詳細なし）";
      }
    }

    function renderTodayList(){
      const hits = store.hitsToday || [];
      if(!hits.length){
        todayEmpty.style.display = "block";
        todayList.innerHTML = "";
        return;
      }
      todayEmpty.style.display = "none";
      // 最新が上
      const view = hits.slice().reverse();
      todayList.innerHTML = view.map(h => `
        <div class="miniRow">
          <div class="miniMain">${h.g}G ${h.type}</div>
          <div class="miniSub">${escapeHtml(makeMiniSub(h))}</div>
          <button class="miniDel" data-del="${h.id}">削除</button>
        </div>
      `).join("");

      todayList.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del");
          if(!confirm("この履歴を削除する？")) return;
          store.hitsToday = (store.hitsToday || []).filter(x => x.id !== id);
          saveStore();
          renderTodayList();
        });
      });
    }

    document.getElementById("btnClearToday").addEventListener("click", () => {
      if(!(store.hitsToday || []).length) return;
      if(!confirm("今日の履歴を全部削除する？（元に戻せません）")) return;
      store.hitsToday = [];
      saveStore();
      renderTodayList();
    });

    /***********************
     * modal（ボーナス追加）
     ***********************/
    const modalBackdrop = document.getElementById("modalBackdrop");
    const mHitG = document.getElementById("mHitG");
    const mTypeSeg = document.getElementById("mTypeSeg");
    const mFeatherBig = document.getElementById("mFeatherBig");
    const mFeatherReg = document.getElementById("mFeatherReg");
    const mSideLamp = document.getElementById("mSideLamp");
    const mSuiAddEl = document.getElementById("mSuiAdd");

    let modalType = "BIG";
    let modalSuiAdd = 0;

    function setModalFields(){
      const isBig = modalType === "BIG";
      mFeatherBig.disabled = !isBig;
      mFeatherReg.disabled = isBig;
      mSideLamp.disabled = isBig;
    }
    function openModal(){
      modalBackdrop.classList.remove("hidden");
      modalBackdrop.setAttribute("aria-hidden","false");
      mHitG.value = "";
      modalType = "BIG";
      modalSuiAdd = 0;
      mSuiAddEl.textContent = "0";
      mFeatherBig.value = "none";
      mFeatherReg.value = "none";
      mSideLamp.value = "none";
      Array.from(mTypeSeg.querySelectorAll("button")).forEach(b => b.classList.toggle("active", b.dataset.type === "BIG"));
      setModalFields();
      setTimeout(()=>mHitG.focus(), 30);
    }
    function closeModal(){
      modalBackdrop.classList.add("hidden");
      modalBackdrop.setAttribute("aria-hidden","true");
    }

    document.getElementById("btnAddBonus").addEventListener("click", openModal);
    document.getElementById("mCancel").addEventListener("click", closeModal);

    mTypeSeg.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-type]");
      if(!btn) return;
      modalType = btn.dataset.type;
      Array.from(mTypeSeg.querySelectorAll("button")).forEach(b => b.classList.toggle("active", b.dataset.type === modalType));
      setModalFields();
    });

    document.getElementById("mSuiPlus").addEventListener("click", () => {
      modalSuiAdd += 1;
      mSuiAddEl.textContent = String(modalSuiAdd);
    });
    document.getElementById("mSuiMinus").addEventListener("click", () => {
      modalSuiAdd = Math.max(0, modalSuiAdd - 1);
      mSuiAddEl.textContent = String(modalSuiAdd);
    });
    document.getElementById("mSuiZero").addEventListener("click", () => {
      modalSuiAdd = 0;
      mSuiAddEl.textContent = "0";
    });

    function addBonusRecord({applyCounts}){
      const g = parseIntSafe(mHitG.value);
      if(g === null){ alert("当選G数を入れてね（例：380）"); return false; }

      // 念のため、追加直前にも日付チェック（深夜跨ぎ対策）
      autoArchiveIfNeeded();
      document.getElementById("todayKeyText").textContent = store.todayKey;

      const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
      const rec = {
        id,
        ts: nowISO(),
        dayKey: store.todayKey,
        g,
        type: modalType,
        featherBig: (modalType === "BIG" ? mFeatherBig.value : "none"),
        featherReg: (modalType === "REG" ? mFeatherReg.value : "none"),
        sideLamp: (modalType === "REG" ? mSideLamp.value : "none"),
        suiAdd: (modalType === "BIG" ? modalSuiAdd : 0)
      };

      store.hitsToday.push(rec);

      if(applyCounts){
        const big = parseIntSafe(elBigCnt.value) ?? 0;
        const reg = parseIntSafe(elRegCnt.value) ?? 0;
        if(modalType === "BIG") elBigCnt.value = String(big + 1);
        if(modalType === "REG") elRegCnt.value = String(reg + 1);

        if(modalType === "BIG" && modalSuiAdd > 0){
          store.inputs.sui = (store.inputs.sui ?? 0) + modalSuiAdd;
          elSuiVal.textContent = String(store.inputs.sui);
        }
      }

      saveInputsFromUI();
      saveStore();
      renderTodayList();
      return true;
    }

    document.getElementById("mSaveOnly").addEventListener("click", () => {
      const ok = addBonusRecord({applyCounts:false});
      if(ok) closeModal();
    });
    document.getElementById("mSaveAndApply").addEventListener("click", () => {
      const ok = addBonusRecord({applyCounts:true});
      if(ok) closeModal();
    });

    modalBackdrop.addEventListener("click", (e) => {
      if(e.target === modalBackdrop) closeModal();
    });

    /***********************
     * 分布（過去アーカイブ）
     ***********************/
    const elHistMaxG = document.getElementById("histMaxG");
    const histWrap = document.getElementById("histWrap");
    const archiveStats = document.getElementById("archiveStats");

    function buildHistBinsFromArchive(maxGOverride){
      const hits = store.hitsArchive || [];
      const maxHit = hits.reduce((m,h)=>Math.max(m, h.g||0), 0);
      const maxG = Math.max(100, maxGOverride ?? 0, maxHit);
      const upper = Math.ceil(maxG / 100) * 100;

      const bins = [];
      for(let start=0; start<upper; start+=100){
        bins.push({ start, end:start+100, total:0, BIG:0, REG:0 });
      }
      for(const h of hits){
        const g = h.g ?? 0;
        const idx = Math.floor(g / 100);
        if(idx >= 0 && idx < bins.length){
          bins[idx].total++;
          if(h.type === "BIG") bins[idx].BIG++;
          if(h.type === "REG") bins[idx].REG++;
        }
      }
      return bins;
    }

    function renderHist(){
      const maxOverride = parseIntSafe(elHistMaxG.value);
      const hits = store.hitsArchive || [];
      if(!hits.length){
        histWrap.innerHTML = `<div class="small" style="margin-top:10px;">過去アーカイブがまだ無いので、分布は表示できないよ。</div>`;
        return;
      }
      const bins = buildHistBinsFromArchive(maxOverride ?? 0);
      const rows = bins.map(b => `
        <tr>
          <td>${b.start}〜${b.end}G</td>
          <td class="right">${b.total}</td>
          <td class="right">${b.BIG}</td>
          <td class="right">${b.REG}</td>
        </tr>
      `).join("");
      histWrap.innerHTML = `
        <table>
          <thead><tr>
            <th>区間</th><th class="right">合計</th><th class="right">BIG</th><th class="right">REG</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function renderArchiveStats(){
      const today = store.hitsToday?.length ?? 0;
      const arc = store.hitsArchive?.length ?? 0;
      const minDay = store.hitsArchive.reduce((m,h)=> m ? (String(h.dayKey) < m ? String(h.dayKey) : m) : String(h.dayKey), "");
      const maxDay = store.hitsArchive.reduce((m,h)=> m ? (String(h.dayKey) > m ? String(h.dayKey) : m) : String(h.dayKey), "");

      let range = "（まだ無し）";
      if(arc > 0) range = `${minDay} 〜 ${maxDay}`;

      archiveStats.textContent = `今日：${today}件 ／ アーカイブ（過去）：${arc}件 ／ 期間：${range}`;
    }

    document.getElementById("btnRefreshHist").addEventListener("click", () => {
      renderHist(); renderArchiveStats();
    });
    elHistMaxG.addEventListener("input", () => { renderHist(); });

    document.getElementById("btnForceArchive").addEventListener("click", () => {
      autoArchiveIfNeeded();
      // 手動アーカイブ：今日以外のdayKeyを today側に混入してた場合も救済
      const today = getTodayKey();
      const keep = [];
      const move = [];
      for(const h of store.hitsToday || []){
        if(String(h.dayKey) === today) keep.push(h);
        else move.push(h);
      }
      if(move.length){
        store.hitsArchive.push(...move);
        store.hitsToday = keep;
        saveStore();
      }
      renderTodayList();
      renderHist();
      renderArchiveStats();
      alert("アーカイブ仕分けを実行しました。");
    });

    /***********************
     * 引き継ぎ（JSON）
     ***********************/
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");
    const btnWipeAll = document.getElementById("btnWipeAll");

    exportBtn.addEventListener("click", () => {
      const data = localStorage.getItem(STORAGE_KEY);
      if(!data){ alert("書き出すデータがありません"); return; }
      const blob = new Blob([data], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "dragon_hana_senka.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", () => importFile.click());
    importFile.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const parsed = JSON.parse(reader.result);
          if(parsed && parsed.version === STORAGE_VERSION){
            // 最低限の形チェック
            if(!parsed.inputs) parsed.inputs = { totalG:"", big:"", reg:"", bell:"", sui:0 };
            if(!Array.isArray(parsed.hitsToday)) parsed.hitsToday = [];
            if(!Array.isArray(parsed.hitsArchive)) parsed.hitsArchive = [];
            if(!parsed.todayKey) parsed.todayKey = getTodayKey();

            localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
            alert("読み込みました。再読み込みします。");
            location.reload();
          }else{
            alert("形式が違うみたい。dragon_hana_senka.json を選んでね。");
          }
        }catch{
          alert("JSONの読み込みに失敗しました");
        }
      };
      reader.readAsText(file);
      importFile.value = "";
    });

    btnWipeAll.addEventListener("click", () => {
      if(!confirm("本当に全データを削除する？（元に戻せません）")) return;
      localStorage.removeItem(STORAGE_KEY);
      alert("削除しました。再読み込みします。");
      location.reload();
    });

    /***********************
     * 起動時
     ***********************/
    loadInputsToUI();
    renderTodayList();
    renderArchiveStats();
    // 分布はタブ開いたときに描画でもOKだけど、初回も軽く
    renderHist();
  </script>
</body>
</html>
